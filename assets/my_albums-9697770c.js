import{r as s,b as M,j as n,F as D,c as t,s as o,u as xe,N as Ne}from"./index-7083d431.js";import{E as Ue}from"./index-7083d431.js";import{A as H,f as De}from"./fetchSignedAlbumUrls-35a279ae.js";function Re({album:c}){const b=s.useRef(null),k=s.useRef(null),g=s.useRef(null),w=s.useRef(null),A=s.useRef(null),f=s.useRef(null),v=s.useRef(null),T=s.useRef(null),R=s.useRef(null),q=s.useRef(null),[u,F]=s.useState(null),[E,W]=s.useState(!0),[I,S]=s.useState(null);s.useEffect(()=>{(async()=>{const{data:r,error:a}=await o.from("my_tracks").select();if(a)throw a;F(r)})().finally(()=>W(!1))},[c]);const d=M(),[J,O]=s.useState(!1),K=()=>O(!0),x=()=>O(!1),Q=async e=>{const{data:r,error:a}=await o.storage.from("album_covers").upload(`${c.album_id}/${e.name}`,e,{upsert:!0});if(a)throw a;return r},X=async e=>{const r=e&&c.album_covers.find(l=>l.endsWith("/"+e.name))||c.album_covers[0];if(!r)throw new Error(`Cannot delete '${e.name}' because it does not exists`);const{data:a,error:i}=await o.storage.from("album_covers").remove([r]);if(i)throw i;return a},Z=async e=>{const{data:r,error:a}=await o.from("owned_albums").update({album_name:e}).eq("album_id",c.album_id);if(a)throw a;return r},ee=async()=>{const{data:e,error:r}=await o.from("owned_albums").delete().eq("album_id",c.album_id);if(r)throw r;return e},re=async()=>{const{data:e,error:r}=await o.from("owned_albums").update({deleted_at:"infinity"}).eq("album_id",c.album_id);if(r)throw r;return e},te=async(e,r)=>{const{data:a,error:i}=await o.from("public_users").select("user_type, user_id").eq("username",e).maybeSingle();if(i)throw i;if(!a)throw new Error(`Cannot find user "${e}"`);const{user_type:l,user_id:h}=a;if(l!=="Creator")throw new Error(`User ${e} is not a Creator`);const{data:y,error:m}=await o.from("album_creators").upsert({album_id:c.album_id,creator_id:h,is_owner:r,deleted_at:"infinity"},{onConflict:"album_id,creator_id"});if(m)throw m;return y},U=async e=>{const{data:r,error:a}=await o.from("owned_album_tracks").upsert({album_id:c.album_id,track_id:e,deleted_at:"infinity"},{onConflict:"album_id,track_id"});if(a)throw a;return r},ae=async e=>{const{data:r,error:a}=await o.from("owned_album_tracks").delete().eq("track_id",e).eq("album_id",c.album_id);if(a)throw a;return r},V=async(e,r)=>{const{data:a,error:i}=await o.storage.from("tracks").upload(`${e}/${r.name}`,r,{upsert:!0});if(i)throw i;return a},ne=async e=>{const{data:r,error:a}=await o.storage.from("tracks").remove([e]);if(a)throw a;return r},ie=async(e,r)=>{const{data:a,error:i}=await o.from("owned_tracks").insert({track_name:e}).select().maybeSingle();if(i)throw i;return await V(a.track_id,r),a},oe=async e=>{const{data:r,error:a}=await o.from("owned_tracks").delete().eq("track_id",e);if(a)throw a;return r},le=async e=>{const{data:r,error:a}=await o.from("owned_tracks").update({deleted_at:"infinity"}).eq("track_id",e);if(a)throw a;return r},ce=async(e,r)=>{const a=await ie(e,r);if(a&&a.track_id)return await U(a.track_id);throw new Error(`Could not add track "${e}" to album: ${a}`)},se=async(e,r,a)=>{const{data:i,error:l}=await o.from("public_users").select("user_type, user_id").eq("username",r).maybeSingle();if(l)throw l;if(!i)throw new Error(`Cannot find user "${r}"`);const{user_type:h,user_id:y}=i;if(h!=="Creator")throw new Error(`User ${r} is not a Creator`);const{data:m,error:_}=await o.from("track_creators").upsert({track_id:e,creator_id:y,is_owner:a,deleted_at:"infinity"},{onConflict:"track_id,creator_id"});if(_)throw _;return m},de=async(e,r)=>{const{data:a,error:i}=await o.from("owned_tracks").update({track_name:r}).eq("track_id",e);if(i)throw i;return a},ue=e=>{e.preventDefault();const r=[],a=b.current.value;a!==c.album_name&&r.push(Z(a));const i=k.current.files[0];i&&r.push(Q(i)),r.length&&Promise.all(r).then(()=>d.revalidate()).finally(x)},me=()=>{const e=k.current.files[0];X(e).then(()=>{d.revalidate()}).finally(x)},he=()=>{ee().then(()=>{d.revalidate()}).finally(x)},fe=()=>{re().then(()=>{d.revalidate()})},pe=()=>{const e=g.current.value,r=w.current.checked;e&&te(e,r).then(()=>{d.revalidate()})},be=e=>{e.preventDefault();const r=A.current.value,a=f.current.files[0];if(!r)throw new Error("Track name is required!");if(!a)throw new Error("Audio track is required for new tracks");ce(r,a).then(()=>{d.revalidate()})},ke=e=>{const r=e.target.name;if(!r)throw new Error("Track ID is required for a track to be added to an album");U(r).then(()=>{d.revalidate()})},we=e=>{const r=e.target.name;if(!r)throw new Error("Cannot delete album track without providing a track ID");ae(r).then(()=>{d.revalidate()})},j=e=>{const r=e.target.name;if(!r)throw new Error("Cannot delete album track without providing a track ID");oe(r).then(()=>{d.revalidate()})},B=e=>{const r=e.target.name;if(!r)throw new Error("Cannot delete album track without providing a track ID");le(r).then(()=>{d.revalidate()})},ye=e=>{const r=e.target.name,a=T.current.value,i=q.current.checked;!r||!a||se(r,a,i).then(()=>{d.revalidate()})},_e=e=>{e.preventDefault();const r=e.target.name,a=v.current.value,i=R.current.files[0];if(!r)throw new Error(`Track ID is required to update track "${r}"`);const l=[];a&&l.push(de(r,a)),i&&l.push(V(r,i)),l.length&&Promise.all(l).then(()=>{d.revalidate()})},ge=e=>{const r=e.target.name;if(!r)throw new Error(`Path to track is required to delete file: ${r}`);const[a,i]=r.split("/");if(isNaN(+a)||!i)throw new Error(`Invalid virtual track path "${r}"`);ne(r).then(()=>{d.revalidate()})},{album_id:Ee,album_name:L,signedUrls:$,album_creators:N,album_tracks:p,deleted_at:ve}=c,P=$&&$.length,Ce=Date.now()+2*1e3,Y=new Date(ve)<=Ce;return n(D,{children:[n("div",{className:`absolute-fill flex-center flex-column ${J?"":"hidden"}`,style:{zIndex:999,backgroundColor:"rgba(0,0,0,0.8)",rowGap:"1em",overflowY:"scroll"},onClick:x,children:[n("form",{onSubmit:ue,onClick:e=>{e.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em"},children:[t("button",{onClick:x,style:{float:"right"},type:"button",children:"Cancel"}),t("h3",{children:"Edit Album"}),n("div",{className:"flex-column gap-s",children:[n("div",{children:[t("h5",{children:"Album Name"}),t("div",{children:t("input",{type:"text",placeholder:"album name...",required:!0,ref:b,defaultValue:L})})]}),n("div",{children:[t("h5",{children:"Album Cover"}),n("div",{children:[t("input",{type:"file",accept:"image/*",placeholder:"Choose Image",ref:k,src:P&&$[0].signedUrl}),P&&t("button",{onClick:me,children:"Delete Image"})]})]}),Array.isArray(N)&&n("div",{children:[t("h5",{children:"Album Creators"}),n("div",{children:[N.map(e=>{const{creator_id:r,first_name:a,last_name:i,is_owner:l}=e,h=()=>{o.from("album_creators").delete().eq("album_id",c.album_id).eq("creator_id",r).then(({data:y,error:m})=>{if(m)throw m;d.revalidate()})};return n("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[t("p",{children:`${a} ${i}`}),t("p",{className:"fs-xxs",children:l?"Owner":"Creator"}),t("button",{disabled:l,onClick:h,children:"Remove"})]},r)}),n("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[t("input",{contentEditable:!0,ref:g,placeholder:"username...",style:{marginRight:"1em"}}),n("div",{children:[t("p",{style:{display:"inline",marginRight:".5em"},children:"Is Owner"}),t("input",{type:"checkbox",ref:w})]}),t("button",{onClick:pe,children:"Add Creator"})]})]})]}),n("div",{className:"flex-center gap-xl",style:{marginTop:"1em"},children:[t("button",{type:"submit",children:"Update Album"}),t("button",{type:"button",onClick:he,children:"Delete Album"})]})]})]}),n("form",{onSubmit:be,onClick:e=>{e.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em"},children:[t("h3",{children:"Add New Track"}),n("div",{className:"flex-column gap-s",children:[n("div",{children:[t("h5",{children:"Track Name"}),t("div",{children:t("input",{type:"text",placeholder:"track name...",required:!0,ref:A,defaultValue:""})})]}),n("div",{children:[t("h5",{children:"Audio File"}),t("div",{children:t("input",{type:"file",accept:"audio/*",ref:f})})]}),t("div",{children:t("button",{type:"submit",children:"Add Track to Album"})})]})]}),n("div",{onClick:e=>{e.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em",margin:"0 1em"},children:[t("h5",{children:"Owned Tracks"}),t("div",{style:{maxHeight:"300px",overflowY:"scroll"},children:!E&&u&&(u==null?void 0:u.map((e,r)=>{const{track_id:a,track_name:i,track_creators:l,audio_files:h,deleted_at:y}=e,m=(p==null?void 0:p.find(C=>C.track_id===a))!=null,_=new Date(y)<=Date.now()+2*1e3;return n("div",{className:"grid",onClick:C=>S(r),style:{gridTemplateColumns:`1fr 1fr 1fr ${_?"2fr":"1fr 1fr"}`,cursor:"pointer",columnGap:"1em"},children:[t("p",{children:i}),t("p",{children:l.map(C=>`${C.first_name} ${C.last_name}`).join(", ")}),t("p",{children:h==null?void 0:h[0]}),_?t("button",{type:"button",onClick:B,name:a,children:"Restore Track"}):n(D,{children:[m?t("button",{type:"button",onClick:we,name:a,children:"Remove From Album"}):t("button",{type:"button",onClick:ke,name:a,children:"Add to Album"}),t("button",{type:"button",onClick:j,name:a,children:"Delete Track"})]})]},a)}))})]}),I>=0&&I!=null&&u&&(()=>{const{track_id:e,track_name:r,track_creators:a,deleted_at:i,audio_files:l}=u[I],h=new Date(i)<=Date.now()+2*1e3,y=Array.isArray(l)&&l.length>0;return t(D,{children:n("form",{name:e,onSubmit:_e,onClick:m=>{m.stopPropagation()},style:{margin:"2em 0"},children:[t("button",{onClick:()=>S(null),style:{float:"right"},type:"button",children:"Cancel"}),t("h3",{children:"Edit Track"}),n("div",{className:"flex-column gap-s",children:[n("div",{children:[t("h5",{children:"Track Name"}),t("div",{children:t("input",{type:"text",placeholder:"track name...",ref:v,defaultValue:r})})]}),n("div",{children:[t("h5",{children:"Audio File"}),n("div",{children:[t("input",{type:"file",accept:"audio/*",ref:R}),y&&t("button",{type:"button",onClick:ge,name:l[0],children:"Delete File"})]})]}),Array.isArray(a)&&n("div",{children:[t("h5",{children:"Track Creators"}),n("div",{children:[a.map(m=>{const{creator_id:_,first_name:C,last_name:Ae,is_owner:z}=m,Te=()=>{o.from("track_creators").delete().eq("track_id",e).eq("creator_id",_).then(({data:$e,error:G})=>{if(G)throw G;d.revalidate()})};return n("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[t("p",{children:`${C} ${Ae}`}),t("p",{className:"fs-xxs",children:z?"Owner":"Creator"}),t("button",{type:"button",disabled:z,onClick:Te,children:"Remove Track Creator"})]},_)}),n("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[t("input",{contentEditable:!0,ref:T,placeholder:"username...",style:{marginRight:"1em"}}),n("div",{children:[t("p",{style:{display:"inline",marginRight:".5em"},children:"Is Owner"}),t("input",{type:"checkbox",ref:q})]}),t("button",{type:"button",onClick:ye,name:e,children:"Add Track Creator"})]})]})]}),h?t("button",{type:"button",onClick:B,name:e,children:"Restore Track"}):n("div",{className:"flex-center gap-xl",style:{marginTop:"1em"},children:[t("button",{type:"submit",children:"Update Track"}),t("button",{type:"button",onClick:j,name:e,children:"Delete Track"})]})]})]})})})(),n("div",{onClick:e=>{e.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em"},children:[t("h4",{children:"Album Tracks"}),t("div",{style:{maxHeight:"100px",overflowY:"scroll"},children:Array.isArray(p)&&p.length>0?t(D,{children:p==null?void 0:p.map(e=>t(H,{track:e},e.track_id))}):t("p",{children:"None"})})]})]}),n("div",{className:"flex bg-neutral-800",style:{flexWrap:"wrap"},children:[n("div",{className:"bg-neutral-800",style:{padding:"2em",flexBasis:"30%",cursor:"pointer"},onClick:Y?fe:K,children:[t("p",{children:Y?"Deleted":""}),P&&t("img",{src:$[0].signedUrl,alt:"album cover"}),t("p",{className:"fs-s",children:L}),t("p",{className:"fs-xs",children:N==null?void 0:N.map(e=>`${e.first_name} ${e.last_name}`).join(", ")})]}),Array.isArray(p)&&t("div",{style:{flexBasis:"70%",padding:"1em"},children:p.map(e=>t(H,{track:e},e.track_id))})]})]})}const Pe=async()=>{const{data:c,error:b}=await o.from("my_profile").select().maybeSingle();if(b)throw b;if(c.user_type!=="Creator")throw new Error("Access Denied: Only Creators can access this page");const{data:k,error:g}=await o.from("my_albums").select().limit(30);if(g)throw g;const{albumCovers:w,trackFiles:A}=await De(k);for(const f of k)if(f.signedUrls=w.get(f.album_id),Array.isArray(f.album_tracks))for(const v of f.album_tracks)v.signedUrl=A.get(v.track_id);return{my_albums:k,my_profile:c}},Fe=function(){const{my_albums:b,my_profile:k}=xe(),g=M(),w=s.useRef(null),[A,f]=s.useState(!1),v=()=>f(!0),T=()=>f(!1),R=async()=>{const u=w.current.value;if(!u)throw new Error("Album name cannot be empty");const{data:F,error:E}=await o.from("owned_albums").insert({album_name:u});if(E)throw E;g.revalidate(),w.current.value=""};return n(D,{children:[t(Ne,{}),t("div",{className:`absolute-fill flex-center bg-neutral-800 ${A?"":"hidden"}`,style:{zIndex:999,opacity:.8},children:n("form",{onSubmit:u=>{u.preventDefault(),R().then(T)},children:[t("button",{onClick:T,style:{float:"right"},type:"button",children:"Cancel"}),t("h4",{children:"New Album"}),t("div",{children:t("input",{type:"text",placeholder:"album name...",ref:w,required:!0})}),t("button",{type:"submit",children:"Create"})]})}),t("h1",{children:"My Albums"}),t("button",{onClick:v,children:"Add Album"}),Array.isArray(b)&&t("div",{children:b.map(u=>t(Re,{album:u},u.album_id))})]})};export{Fe as Component,Ue as ErrorBoundary,Pe as loader};
