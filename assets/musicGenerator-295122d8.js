import{s as R,u as L,b as N,r as k,j as i,F as m,c as r,N as S}from"./index-88cc3bb7.js";import{a as C}from"./tracks-6e7a3842.js";const G=(e,{method:t="GET",headers:s={},body:a=null,signal:n=null,timeout:b=300*1e3,responseType:g="blob"}={})=>{const o=new XMLHttpRequest;o.open(t,e);for(const[l,u]of Object.entries(s))o.setRequestHeader(l,u);return n==null||n.addEventListener("abort",function(l){o.abort()},{once:!0}),o.timeout=b,o.responseType=g,o.send(a),new Promise((l,u)=>{o.onerror=function(c){u({statusCode:this.status,message:this.statusText,response:this.response})},o.ontimeout=function(c){u({statusCode:408,message:`Request for ${e} timed out after ${this.timeout/1e3} seconds`})},o.onabort=function(c){l(n.reason)},o.onload=function(c){const h=this.getAllResponseHeaders().trim().split(/[\r\n]+/),w=new Headers;for(const v of h){const y=v.split(": "),T=y.shift(),x=y.join(": ");w.set(T,x)}const U=new Response(this.response,{status:this.status,statusText:this.statusText,headers:w});l(U)}})};class p{constructor(t=null){this.baseUrl=t,this.defaultHeaders={"Bypass-Tunnel-Reminder":!0}}static async asyncGetBaseUrl(t=null){const{data:s,error:a}=await R.from("public_settings").select("value").eq("id","PUBLIC_API_URL").abortSignal(t).maybeSingle();if(a)throw a;const n=s==null?void 0:s.value;if(!n)throw new Error("Site setting 'PUBLIC_API_URL' is empty");return n}async musicgen(t,{signal:s=null}={}){this.baseUrl||(this.baseUrl=await p.asyncGetBaseUrl(s));const a=new URL(this.baseUrl);return a.pathname="/musicgen",a.searchParams.set("description",t),await G(a,{signal:s,headers:this.defaultHeaders})}async status({signal:t=null}={}){this.baseUrl||(this.baseUrl=await p.asyncGetBaseUrl(t));const s=new URL(this.baseUrl);return s.pathname="/status",await fetch(s,{signal:t,headers:{...this.defaultHeaders}})}}const f=new p,I=async()=>{try{const e=await f.status(),t=e.headers.get("Content-Type");if(t.startsWith("application/json"))return await e.json();if(t.startsWith("text/html")){const s=`data:${t},${encodeURIComponent(await e.text())}`;return{data:null,error:{htmlSrc:e.url,html:s}}}}catch(e){return e instanceof Error&&(e=e.message),{data:null,error:e}}},H=async e=>{const t=await f.musicgen(e),s=t.headers.get("Content-Type");if(s.startsWith("audio/")){const a=await t.blob();return{blob:a,url:URL.createObjectURL(a)}}if(s.startsWith("application/json")){const{data:a,error:n}=await t.json();if(n)throw n;return a}throw{statusCode:t.status,message:t.statusText}},P=()=>{var u;const e=L(),t=N(),[s,a]=k.useState(!1),n=k.useRef(null),b=c=>{c.preventDefault(),a(!0);const d=new FormData(c.target);H(d.get("trackDescription")).then(h=>{n.current=h}).finally(()=>{a(!1)})},g=c=>{f.constructor.asyncGetBaseUrl().then(d=>{f.baseUrl=d,t.revalidate()})},o=c=>{const h=new FormData(c.target).get("trackName");C(h,n.current.blob).then(()=>console.log("added new track!"))},l=e.error==null;return i(m,{children:[r(S,{}),r("section",{className:"flex-center",children:i("div",{children:[r("h1",{children:"Music Generator"}),l?i(m,{children:[i("form",{onSubmit:b,children:[i("div",{children:[r("p",{children:"Please provide a brief description of what your new track should sound like."}),r("textarea",{name:"trackDescription",placeholder:"track description...",maxLength:128,required:!0,autoFocus:!0,cols:50})]}),r("button",{type:"submit",disabled:s,children:"Generate Track"})]}),s&&i(m,{children:[r("h3",{children:"Generating Track..."}),i("p",{children:["Utilizing ",e.data.gpu_enabled?`${e.data.gpu_count} ${e.data.gpu}`:`${e.data.cpu} cpu`]})]}),n.current&&i("div",{children:[i("div",{className:"flex-center flex-column",children:[r("h3",{children:"Generated Track"}),r("audio",{src:n.current.url,controls:!0})]}),r("form",{onSubmit:o,className:"flex-column",style:{alignItems:"center"},children:i("div",{className:"flex-column gap-xs",style:{margin:"1em"},children:[i("div",{className:"flex gap-s",children:[r("p",{children:"Track Name"}),r("input",{type:"text",placeholder:"track name...",name:"trackName",required:!0})]}),r("div",{children:r("button",{type:"submit",style:{marginLeft:"auto"},children:"Save To My Tracks"})})]})})]})]}):i(m,{children:[r("h2",{children:"Service is Offline"}),((u=e.error)==null?void 0:u.htmlSrc)!=null?r("div",{children:r("iframe",{src:e.error.html,className:"bg-neutral-100"})}):r("p",{children:JSON.stringify(e.error)}),r("button",{type:"button",onClick:g,children:"Refresh"})]})]})})]})};export{P as Component,I as loader};
