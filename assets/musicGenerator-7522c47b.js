import{s as w,u as k,b as U,r as f,j as i,F as u,c as t,N as v}from"./index-e5ea5249.js";import{a as x}from"./tracks-6dafb6ab.js";class d{constructor(e=null){this.baseUrl=e,this.defaultHeaders={"Bypass-Tunnel-Reminder":!0}}static async asyncGetBaseUrl(e=null){const{data:a,error:s}=await w.from("public_settings").select("value").eq("id","PUBLIC_API_URL").abortSignal(e).maybeSingle();if(s)throw s;const n=a==null?void 0:a.value;if(!n)throw new Error("Site setting 'PUBLIC_API_URL' is empty");return n}async musicgen(e,{signal:a=null}={}){this.baseUrl||(this.baseUrl=await d.asyncGetBaseUrl(a));const s=new URL(this.baseUrl);s.pathname="/musicgen",s.searchParams.set("description",e);const n=()=>fetch(s,{signal:a,headers:{...this.defaultHeaders}});try{return await n()}catch(o){if(o instanceof TypeError)return Promise.reject({level:"warn",message:"Request is taking longer than usual, retrying..."}),await n();throw o}}async status({signal:e=null}={}){this.baseUrl||(this.baseUrl=await d.asyncGetBaseUrl(e));const a=new URL(this.baseUrl);return a.pathname="/status",await fetch(a,{signal:e,headers:{...this.defaultHeaders}})}}const h=new d,R=async()=>{try{const r=await h.status(),e=r.headers.get("Content-Type");if(e.startsWith("application/json"))return await r.json();if(e.startsWith("text/html")){const a=`data:${e},${encodeURIComponent(await r.text())}`;return{data:null,error:{htmlSrc:r.url,html:a}}}}catch(r){return r instanceof Error&&(r=r.message),{data:null,error:r}}},T=async r=>{const e=await h.musicgen(r),a=e.headers.get("Content-Type");if(a.startsWith("audio/")){const s=await e.blob();return{blob:s,url:URL.createObjectURL(s)}}if(a.startsWith("application/json")){const{data:s,error:n}=await e.json();if(n)throw n;return s}throw{statusCode:e.status,message:e.statusText}},S=()=>{var p;const r=k(),e=U(),[a,s]=f.useState(!1),n=f.useRef(null),o=c=>{c.preventDefault(),s(!0);const l=new FormData(c.target);T(l.get("trackDescription")).then(m=>{n.current=m}).finally(()=>{s(!1)})},g=c=>{h.constructor.asyncGetBaseUrl().then(l=>{h.baseUrl=l,e.revalidate()})},b=c=>{const m=new FormData(c.target).get("trackName");x(m,n.current.blob).then(()=>console.log("added new track!"))},y=r.error==null;return i(u,{children:[t(v,{}),t("section",{className:"flex-center",children:i("div",{children:[t("h1",{children:"Music Generator"}),y?i(u,{children:[i("form",{onSubmit:o,children:[i("div",{children:[t("p",{children:"Please provide a brief description of what your new track should sound like."}),t("textarea",{name:"trackDescription",placeholder:"track description...",maxLength:128,required:!0,autoFocus:!0,cols:50})]}),t("button",{type:"submit",disabled:a,children:"Generate Track"})]}),a&&i(u,{children:[t("h3",{children:"Generating Track..."}),i("p",{children:["Utilizing ",r.data.gpu_count," ",r.data.gpu]})]}),n.current&&i("div",{children:[i("div",{className:"flex-center flex-column",children:[t("h3",{children:"Generated Track"}),t("audio",{src:n.current.url,controls:!0})]}),t("form",{onSubmit:b,className:"flex-column",style:{alignItems:"center"},children:i("div",{className:"flex-column gap-xs",style:{margin:"1em"},children:[i("div",{className:"flex gap-s",children:[t("p",{children:"Track Name"}),t("input",{type:"text",placeholder:"track name...",name:"trackName",required:!0})]}),t("div",{children:t("button",{type:"submit",style:{marginLeft:"auto"},children:"Save To My Tracks"})})]})})]})]}):i(u,{children:[t("h2",{children:"Service is Offline"}),((p=r.error)==null?void 0:p.htmlSrc)!=null?t("div",{children:t("iframe",{src:r.error.html,className:"bg-neutral-100"})}):t("p",{children:JSON.stringify(r.error)}),t("button",{type:"button",onClick:g,children:"Refresh"})]})]})})]})};export{S as Component,R as loader};
