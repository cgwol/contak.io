import{s as m,r as s,b as z,j as n,F as D,c as e,u as ue,N as me}from"./index-e5ea5249.js";import{E as je}from"./index-e5ea5249.js";import{A as Y,f as he}from"./fetchSignedAlbumUrls-2c45e6a7.js";import{a as fe,d as pe,r as be,b as ke,u as ye,c as we,e as _e}from"./tracks-6dafb6ab.js";const ve=async a=>{if(!a)throw new Error("Album name cannot be empty");const{data:l,error:i}=await m.from("owned_albums").insert({album_name:a});if(i)throw i;return l},ge=async(a,l)=>{const{data:i,error:c}=await m.storage.from("album_covers").upload(`${a}/${l.name}`,l,{upsert:!0});if(c)throw c;return i},Ae=async a=>{const{data:l,error:i}=await m.storage.from("album_covers").remove([a]);if(i)throw i;return l},Ce=async(a,l)=>{const{data:i,error:c}=await m.from("owned_albums").update({album_name:l}).eq("album_id",a);if(c)throw c;return i},Te=async a=>{const{data:l,error:i}=await m.from("owned_albums").delete().eq("album_id",a);if(i)throw i;return l},xe=async a=>{const{data:l,error:i}=await m.from("owned_albums").update({deleted_at:"infinity"}).eq("album_id",a);if(i)throw i;return l},Ne=async(a,l,i)=>{const{data:c,error:p}=await m.from("public_users").select("user_type, user_id").eq("username",l).maybeSingle();if(p)throw p;if(!c)throw new Error(`Cannot find user "${l}"`);const{user_type:y,user_id:f}=c;if(y!=="Creator")throw new Error(`User ${l} is not a Creator`);const{data:k,error:w}=await m.from("album_creators").upsert({album_id:a,creator_id:f,is_owner:i,deleted_at:"infinity"},{onConflict:"album_id,creator_id"});if(w)throw w;return k},G=async(a,l)=>{const{data:i,error:c}=await m.from("owned_album_tracks").upsert({album_id:a,track_id:l,deleted_at:"infinity"},{onConflict:"album_id,track_id"});if(c)throw c;return i},De=async(a,l)=>{const{data:i,error:c}=await m.from("owned_album_tracks").delete().eq("track_id",l).eq("album_id",a);if(c)throw c;return i},Re=async(a,l,i)=>{const c=await fe(l,i);if(c&&c.track_id)return await G(a,c.track_id);throw new Error(`Could not add track "${l}" to album: ${c}`)};function Ee({album:a}){const l=s.useRef(null),i=s.useRef(null),c=s.useRef(null),p=s.useRef(null),y=s.useRef(null),f=s.useRef(null),k=s.useRef(null),w=s.useRef(null),$=s.useRef(null),g=s.useRef(null),[_,H]=s.useState(null),[M,I]=s.useState(!0),[q,F]=s.useState(null);s.useEffect(()=>{const r=async()=>{const{data:t,error:o}=await m.from("my_tracks").select();if(o)throw o;H(t)};I(!0),r().finally(()=>I(!1))},[a]);const d=z(),[W,O]=s.useState(!1),J=()=>O(!0),T=()=>O(!1),K=r=>{r.preventDefault();const t=[],o=l.current.value;o!==a.album_name&&t.push(Ce(a.album_id,o));const u=i.current.files[0];u&&t.push(ge(a.album_id,u)),t.length&&Promise.all(t).then(()=>d.revalidate()).finally(T)},Q=()=>{const r=i.current.files[0],t=r&&a.album_covers.find(o=>o.endsWith("/"+r.name))||a.album_covers[0];if(!t)throw new Error(`Cannot delete '${r==null?void 0:r.name}' because it does not exists`);Ae(t).then(()=>{d.revalidate()}).finally(T)},X=()=>{Te(a.album_id).then(()=>{d.revalidate()}).finally(T)},Z=()=>{xe(a.album_id).then(()=>{d.revalidate()})},ee=()=>{const r=c.current.value,t=p.current.checked;r&&Ne(a.album_id,r,t).then(()=>{d.revalidate()})},re=r=>{r.preventDefault();const t=y.current.value,o=f.current.files[0];if(!t)throw new Error("Track name is required!");if(!o)throw new Error("Audio track is required for new tracks");Re(a.album_id,t,o).then(()=>{d.revalidate()})},te=r=>{const t=r.target.name;if(!t)throw new Error("Track ID is required for a track to be added to an album");G(a.album_id,t).then(()=>{d.revalidate()})},ae=r=>{const t=r.target.name;if(!t)throw new Error("Cannot delete album track without providing a track ID");De(a.album_id,t).then(()=>{d.revalidate()})},S=r=>{const t=r.target.name;if(!t)throw new Error("Cannot delete album track without providing a track ID");pe(t).then(()=>{d.revalidate()})},U=r=>{const t=r.target.name;if(!t)throw new Error("Cannot delete album track without providing a track ID");be(t).then(()=>{d.revalidate()})},ne=r=>{const t=r.target.name,o=w.current.value,u=g.current.checked;!t||!o||ke(t,o,u).then(()=>{d.revalidate()})},le=r=>{r.preventDefault();const t=r.target.name,o=k.current.value,u=$.current.files[0];if(!t)throw new Error(`Track ID is required to update track "${t}"`);const h=[];o&&h.push(ye(t,o)),u&&h.push(we(t,u)),h.length&&Promise.all(h).then(()=>{d.revalidate()})},ie=r=>{const t=r.target.name;if(!t)throw new Error(`Path to track is required to delete file: ${t}`);const[o,u]=t.split("/");if(isNaN(+o)||!u)throw new Error(`Invalid virtual track path "${t}"`);_e(t).then(()=>{d.revalidate()})},{album_id:$e,album_name:V,signedUrls:R,album_creators:x,album_tracks:b,deleted_at:oe}=a,P=R&&R.length,ce=Date.now()+2*1e3,j=new Date(oe)<=ce;return n(D,{children:[n("div",{className:`absolute-fill flex-center flex-column ${W?"":"hidden"}`,style:{zIndex:999,backgroundColor:"rgba(0,0,0,0.8)",rowGap:"1em",overflowY:"scroll"},onClick:T,children:[n("form",{onSubmit:K,onClick:r=>{r.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em"},children:[e("button",{onClick:T,style:{float:"right"},type:"button",children:"Cancel"}),e("h3",{children:"Edit Album"}),n("div",{className:"flex-column gap-s",children:[n("div",{children:[e("h5",{children:"Album Name"}),e("div",{children:e("input",{type:"text",placeholder:"album name...",required:!0,ref:l,defaultValue:V})})]}),n("div",{children:[e("h5",{children:"Album Cover"}),n("div",{children:[e("input",{type:"file",accept:"image/*",placeholder:"Choose Image",ref:i,src:P&&R[0].signedUrl}),P&&e("button",{onClick:Q,children:"Delete Image"})]})]}),Array.isArray(x)&&n("div",{children:[e("h5",{children:"Album Creators"}),n("div",{children:[x.map(r=>{const{creator_id:t,first_name:o,last_name:u,is_owner:h}=r,A=()=>{m.from("album_creators").delete().eq("album_id",a.album_id).eq("creator_id",t).then(({data:E,error:v})=>{if(v)throw v;d.revalidate()})};return n("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[e("p",{children:`${o} ${u}`}),e("p",{className:"fs-xxs",children:h?"Owner":"Creator"}),e("button",{disabled:h,onClick:A,children:"Remove"})]},t)}),n("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[e("input",{contentEditable:!0,ref:c,placeholder:"username...",style:{marginRight:"1em"}}),n("div",{children:[e("p",{style:{display:"inline",marginRight:".5em"},children:"Is Owner"}),e("input",{type:"checkbox",ref:p})]}),e("button",{onClick:ee,children:"Add Creator"})]})]})]}),n("div",{className:"flex-center gap-xl",style:{marginTop:"1em"},children:[e("button",{type:"submit",children:"Update Album"}),e("button",{type:"button",onClick:X,children:"Delete Album"})]})]})]}),n("form",{onSubmit:re,onClick:r=>{r.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em"},children:[e("h3",{children:"Add New Track"}),n("div",{className:"flex-column gap-s",children:[n("div",{children:[e("h5",{children:"Track Name"}),e("div",{children:e("input",{type:"text",placeholder:"track name...",required:!0,ref:y,defaultValue:""})})]}),n("div",{children:[e("h5",{children:"Audio File"}),e("div",{children:e("input",{type:"file",accept:"audio/*",ref:f})})]}),e("div",{children:e("button",{type:"submit",children:"Add Track to Album"})})]})]}),n("div",{onClick:r=>{r.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em",margin:"0 1em"},children:[e("h5",{children:"Owned Tracks"}),e("div",{style:{maxHeight:"300px",overflowY:"scroll"},children:!M&&_&&(_==null?void 0:_.map((r,t)=>{const{track_id:o,track_name:u,track_creators:h,audio_files:A,deleted_at:E}=r,v=(b==null?void 0:b.find(C=>C.track_id===o))!=null,N=new Date(E)<=Date.now()+2*1e3;return n("div",{className:"grid",onClick:C=>F(t),style:{gridTemplateColumns:`1fr 1fr 1fr ${N?"2fr":"1fr 1fr"}`,cursor:"pointer",columnGap:"1em"},children:[e("p",{children:u}),e("p",{children:h.map(C=>`${C.first_name} ${C.last_name}`).join(", ")}),e("p",{children:A==null?void 0:A[0]}),N?e("button",{type:"button",onClick:U,name:o,children:"Restore Track"}):n(D,{children:[v?e("button",{type:"button",onClick:ae,name:o,children:"Remove From Album"}):e("button",{type:"button",onClick:te,name:o,children:"Add to Album"}),e("button",{type:"button",onClick:S,name:o,children:"Delete Track"})]})]},o)}))})]}),q>=0&&q!=null&&_&&(()=>{const{track_id:r,track_name:t,track_creators:o,deleted_at:u,audio_files:h}=_[q],A=new Date(u)<=Date.now()+2*1e3,E=Array.isArray(h)&&h.length>0;return e(D,{children:n("form",{name:r,onSubmit:le,onClick:v=>{v.stopPropagation()},style:{margin:"2em 0"},children:[e("button",{onClick:()=>F(null),style:{float:"right"},type:"button",children:"Cancel"}),e("h3",{children:"Edit Track"}),n("div",{className:"flex-column gap-s",children:[n("div",{children:[e("h5",{children:"Track Name"}),e("div",{children:e("input",{type:"text",placeholder:"track name...",ref:k,defaultValue:t})})]}),n("div",{children:[e("h5",{children:"Audio File"}),n("div",{children:[e("input",{type:"file",accept:"audio/*",ref:$}),E&&e("button",{type:"button",onClick:ie,name:h[0],children:"Delete File"})]})]}),Array.isArray(o)&&n("div",{children:[e("h5",{children:"Track Creators"}),n("div",{children:[o.map(v=>{const{creator_id:N,first_name:C,last_name:se,is_owner:B}=v,de=()=>{m.from("track_creators").delete().eq("track_id",r).eq("creator_id",N).then(({data:qe,error:L})=>{if(L)throw L;d.revalidate()})};return n("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[e("p",{children:`${C} ${se}`}),e("p",{className:"fs-xxs",children:B?"Owner":"Creator"}),e("button",{type:"button",disabled:B,onClick:de,children:"Remove Track Creator"})]},N)}),n("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[e("input",{contentEditable:!0,ref:w,placeholder:"username...",style:{marginRight:"1em"}}),n("div",{children:[e("p",{style:{display:"inline",marginRight:".5em"},children:"Is Owner"}),e("input",{type:"checkbox",ref:g})]}),e("button",{type:"button",onClick:ne,name:r,children:"Add Track Creator"})]})]})]}),A?e("button",{type:"button",onClick:U,name:r,children:"Restore Track"}):n("div",{className:"flex-center gap-xl",style:{marginTop:"1em"},children:[e("button",{type:"submit",children:"Update Track"}),e("button",{type:"button",onClick:S,name:r,children:"Delete Track"})]})]})]})})})(),n("div",{onClick:r=>{r.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em"},children:[e("h4",{children:"Album Tracks"}),e("div",{style:{maxHeight:"100px",overflowY:"scroll"},children:Array.isArray(b)&&b.length>0?e(D,{children:b==null?void 0:b.map(r=>e(Y,{track:r},r.track_id))}):e("p",{children:"None"})})]})]}),n("div",{className:"flex bg-neutral-800",style:{flexWrap:"wrap"},children:[n("div",{className:"bg-neutral-800",style:{padding:"2em",flexBasis:"30%",cursor:"pointer"},onClick:j?Z:J,children:[e("p",{children:j?"Deleted":""}),P&&e("img",{src:R[0].signedUrl,alt:"album cover"}),e("p",{className:"fs-s",children:V}),e("p",{className:"fs-xs",children:x==null?void 0:x.map(r=>`${r.first_name} ${r.last_name}`).join(", ")})]}),Array.isArray(b)&&e("div",{style:{flexBasis:"70%",padding:"1em"},children:b.map(r=>e(Y,{track:r},r.track_id))})]})]})}const Oe=async()=>{const{data:a,error:l}=await m.from("my_profile").select().maybeSingle();if(l)throw l;if(a.user_type!=="Creator")throw new Error("Access Denied: Only Creators can access this page");const{data:i,error:c}=await m.from("my_albums").select().limit(30);if(c)throw c;const{albumCovers:p,trackFiles:y}=await he(i);for(const f of i)if(f.signedUrls=p.get(f.album_id),Array.isArray(f.album_tracks))for(const k of f.album_tracks)k.signedUrl=y.get(k.track_id);return{my_albums:i,my_profile:a}},Se=function(){const{my_albums:l,my_profile:i}=ue(),c=z(),p=s.useRef(null),[y,f]=s.useState(!1),k=()=>f(!0),w=()=>f(!1);return n(D,{children:[e(me,{}),e("div",{className:`absolute-fill flex-center bg-neutral-800 ${y?"":"hidden"}`,style:{zIndex:999,opacity:.8},children:n("form",{onSubmit:g=>{g.preventDefault();const _=p.current.value;ve(_).then(()=>{w(),c.revalidate(),p.current.value=""})},children:[e("button",{onClick:w,style:{float:"right"},type:"button",children:"Cancel"}),e("h4",{children:"New Album"}),e("div",{children:e("input",{type:"text",placeholder:"album name...",ref:p,required:!0})}),e("button",{type:"submit",children:"Create"})]})}),e("h1",{children:"My Albums"}),e("button",{onClick:k,children:"Add Album"}),Array.isArray(l)&&e("div",{children:l.map(g=>e(Ee,{album:g},g.album_id))})]})};export{Se as Component,je as ErrorBoundary,Oe as loader};
