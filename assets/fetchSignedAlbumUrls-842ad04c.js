import{r as u,j as l,c as e,d as be,f as ke,e as ge,s as h,g as ve,b as ye,F as U}from"./index-88cc3bb7.js";import{a as we,d as _e,r as Ae,b as Ce,u as Te,c as xe,e as Ee}from"./tracks-6e7a3842.js";const Ne=(t,{volume:i=1,playbackRate:a=1,autoPlay:s=!1}={})=>{const[m,d]=u.useState(s),o=u.useMemo(()=>new Audio(t),[t]),p=u.useRef(!1),g=()=>{if(p.current){o.play();return}o.src=t,o.addEventListener("canplay",()=>o.play(),{once:!0})};return u.useEffect(()=>{o.volume=i},[i,o]),u.useEffect(()=>{o.playbackRate=a},[a,o]),u.useEffect(()=>{s&&o.play();function k(){d(!this.paused&&!this.ended)}function A(){p.current=!1}function w(){p.current=!0}return o.addEventListener("play",k),o.addEventListener("pause",k),o.addEventListener("ended",k),o.addEventListener("loadstart",A),o.addEventListener("canplay",w),()=>{o.removeEventListener("play",k),o.removeEventListener("pause",k),o.removeEventListener("ended",k),o.removeEventListener("loadstart",A),o.removeEventListener("canplay",w)}},[o]),{audio:o,isPlaying:m,play:g}},B=({track:t})=>{const{track_name:i,track_creators:a,signedUrl:s}=t,{audio:m,isPlaying:d}=Ne(s,{});return l("div",{className:"grid",style:{gridTemplateColumns:"1fr 1fr 2fr",columnGap:"1em"},children:[e("button",{onClick:()=>d?m.pause():m.play(),disabled:!s,children:e(be,{icon:d?ke:ge})}),e("p",{children:i}),e("p",{children:a==null?void 0:a.map(o=>`${o.first_name} ${o.last_name}`).join(", ")})]})},Be=async t=>{if(!t)throw new Error("Album name cannot be empty");const{data:i,error:a}=await h.from("owned_albums").insert({album_name:t});if(a)throw a;return i},De=async(t,i)=>{const{data:a,error:s}=await h.storage.from("album_covers").upload(`${t}/${i.name}`,i,{upsert:!0});if(s)throw s;return a},Re=async t=>{const{data:i,error:a}=await h.storage.from("album_covers").remove([t]);if(a)throw a;return i},Pe=async(t,i)=>{const{data:a,error:s}=await h.from("owned_albums").update({album_name:i}).eq("album_id",t);if(s)throw s;return a},Ue=async t=>{const{data:i,error:a}=await h.from("owned_albums").delete().eq("album_id",t);if(a)throw a;return i},$e=async t=>{const{data:i,error:a}=await h.from("owned_albums").update({deleted_at:"infinity"}).eq("album_id",t);if(a)throw a;return i},qe=async(t,i,a)=>{const{data:s,error:m}=await h.from("public_users").select("user_type, user_id").eq("username",i).maybeSingle();if(m)throw m;if(!s)throw new Error(`Cannot find user "${i}"`);const{user_type:d,user_id:o}=s;if(d!=="Creator")throw new Error(`User ${i} is not a Creator`);const{data:p,error:g}=await h.from("album_creators").upsert({album_id:t,creator_id:o,is_owner:a,deleted_at:"infinity"},{onConflict:"album_id,creator_id"});if(g)throw g;return p},H=async(t,i)=>{const{data:a,error:s}=await h.from("owned_album_tracks").upsert({album_id:t,track_id:i,deleted_at:"infinity"},{onConflict:"album_id,track_id"});if(s)throw s;return a},Fe=async(t,i)=>{const{data:a,error:s}=await h.from("owned_album_tracks").delete().eq("track_id",i).eq("album_id",t);if(s)throw s;return a},Ie=async(t,i,a)=>{const s=await we(i,a);if(s&&s.track_id)return await H(t,s.track_id);throw new Error(`Could not add track "${i}" to album: ${s}`)},Se=async(t,i)=>{const{data:a,error:s}=await h.from("purchased_albums").upsert({album_id:t,user_id:i},{onConflict:"album_id,user_id"});if(s)throw s;return a},Oe=async(t,i)=>{const{data:a,error:s}=await h.from("purchased_albums").delete().eq("album_id",t).eq("user_id",i);if(s)throw s;return a};function He({album:t}){const i=u.useRef(null),a=u.useRef(null),s=u.useRef(null),m=u.useRef(null),d=u.useRef(null),o=u.useRef(null),p=u.useRef(null),g=u.useRef(null),k=u.useRef(null),A=u.useRef(null),[w,W]=u.useState(null),[z,F]=u.useState(!0),[$,I]=u.useState(null),[D,J]=ve();u.useEffect(()=>{const r=async()=>{const{data:n,error:c}=await h.from("my_tracks").select();if(c)throw c;W(n)};F(!0),r().finally(()=>F(!1))},[t]);const f=ye(),[K,S]=u.useState(!1),Q=()=>S(!0),E=()=>S(!1),X=r=>{r.preventDefault();const n=[],c=i.current.value;c!==t.album_name&&n.push(Pe(t.album_id,c));const b=a.current.files[0];b&&n.push(De(t.album_id,b)),n.length&&Promise.all(n).then(()=>f.revalidate()).finally(E)},Z=()=>{const r=a.current.files[0],n=r&&t.album_covers.find(c=>c.endsWith("/"+r.name))||t.album_covers[0];if(!n)throw new Error(`Cannot delete '${r==null?void 0:r.name}' because it does not exists`);Re(n).then(()=>{f.revalidate()}).finally(E)},ee=()=>{Ue(t.album_id).then(()=>{f.revalidate()}).finally(E)},re=()=>{$e(t.album_id).then(()=>{f.revalidate()})},te=()=>{const r=s.current.value,n=m.current.checked;r&&qe(t.album_id,r,n).then(()=>{f.revalidate()})},ne=r=>{r.preventDefault();const n=d.current.value,c=o.current.files[0];if(!n)throw new Error("Track name is required!");if(!c)throw new Error("Audio track is required for new tracks");Ie(t.album_id,n,c).then(()=>{f.revalidate()})},ae=r=>{const n=r.target.name;if(!n)throw new Error("Track ID is required for a track to be added to an album");H(t.album_id,n).then(()=>{f.revalidate()})},ie=r=>{const n=r.target.name;if(!n)throw new Error("Cannot delete album track without providing a track ID");Fe(t.album_id,n).then(()=>{f.revalidate()})},O=r=>{const n=r.target.name;if(!n)throw new Error("Cannot delete album track without providing a track ID");_e(n).then(()=>{f.revalidate()})},L=r=>{const n=r.target.name;if(!n)throw new Error("Cannot delete album track without providing a track ID");Ae(n).then(()=>{f.revalidate()})},se=r=>{const n=r.target.name,c=g.current.value,b=A.current.checked;!n||!c||Ce(n,c,b).then(()=>{f.revalidate()})},le=r=>{r.preventDefault();const n=r.target.name,c=p.current.value,b=k.current.files[0];if(!n)throw new Error(`Track ID is required to update track "${n}"`);const v=[];c&&v.push(Te(n,c)),b&&v.push(xe(n,b)),v.length&&Promise.all(v).then(()=>{f.revalidate()})},oe=r=>{const n=r.target.name;if(!n)throw new Error(`Path to track is required to delete file: ${n}`);const[c,b]=n.split("/");if(isNaN(+c)||!b)throw new Error(`Invalid virtual track path "${n}"`);Ee(n).then(()=>{f.revalidate()})},ce=r=>{r.preventDefault(),Se(t.album_id,D.user.id).then(()=>f.revalidate())},de=r=>{r.preventDefault(),Oe(t.album_id,D.user.id).then(()=>f.revalidate())},{album_id:Ve,album_name:j,signedUrls:R,album_creators:x,album_tracks:y,deleted_at:ue,is_purchased_by_user:me}=t,q=R&&R.length,fe=Date.now()+2*1e3,V=new Date(ue)<=fe,G=!J&&D&&x.some(r=>r.creator_id==D.user.id);return l(U,{children:[l("div",{className:`absolute-fill flex-center flex-column ${K?"":"hidden"}`,style:{zIndex:999,backgroundColor:"rgba(0,0,0,0.8)",rowGap:"1em",overflowY:"scroll"},onClick:E,children:[l("form",{onSubmit:X,onClick:r=>{r.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em"},children:[e("button",{onClick:E,style:{float:"right"},type:"button",children:"Cancel"}),e("h3",{children:"Edit Album"}),l("div",{className:"flex-column gap-s",children:[l("div",{children:[e("h5",{children:"Album Name"}),e("div",{children:e("input",{type:"text",placeholder:"album name...",required:!0,ref:i,defaultValue:j})})]}),l("div",{children:[e("h5",{children:"Album Cover"}),l("div",{children:[e("input",{type:"file",accept:"image/*",placeholder:"Choose Image",ref:a,src:q&&R[0].signedUrl}),q&&e("button",{onClick:Z,children:"Delete Image"})]})]}),Array.isArray(x)&&l("div",{children:[e("h5",{children:"Album Creators"}),l("div",{children:[x.map(r=>{const{creator_id:n,first_name:c,last_name:b,is_owner:v}=r,C=()=>{h.from("album_creators").delete().eq("album_id",t.album_id).eq("creator_id",n).then(({data:P,error:_})=>{if(_)throw _;f.revalidate()})};return l("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[e("p",{children:`${c} ${b}`}),e("p",{className:"fs-xxs",children:v?"Owner":"Creator"}),e("button",{disabled:v,onClick:C,children:"Remove"})]},n)}),l("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[e("input",{contentEditable:!0,ref:s,placeholder:"username...",style:{marginRight:"1em"}}),l("div",{children:[e("p",{style:{display:"inline",marginRight:".5em"},children:"Is Owner"}),e("input",{type:"checkbox",ref:m})]}),e("button",{onClick:te,children:"Add Creator"})]})]})]}),l("div",{className:"flex-center gap-xl",style:{marginTop:"1em"},children:[e("button",{type:"submit",children:"Update Album"}),e("button",{type:"button",onClick:ee,children:"Delete Album"})]})]})]}),l("form",{onSubmit:ne,onClick:r=>{r.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em"},children:[e("h3",{children:"Add New Track"}),l("div",{className:"flex-column gap-s",children:[l("div",{children:[e("h5",{children:"Track Name"}),e("div",{children:e("input",{type:"text",placeholder:"track name...",required:!0,ref:d,defaultValue:""})})]}),l("div",{children:[e("h5",{children:"Audio File"}),e("div",{children:e("input",{type:"file",accept:"audio/*",ref:o})})]}),e("div",{children:e("button",{type:"submit",children:"Add Track to Album"})})]})]}),l("div",{onClick:r=>{r.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em",margin:"0 1em"},children:[e("h5",{children:"Owned Tracks"}),e("div",{style:{maxHeight:"300px",overflowY:"scroll"},children:!z&&w&&(w==null?void 0:w.map((r,n)=>{const{track_id:c,track_name:b,track_creators:v,audio_files:C,deleted_at:P}=r,_=(y==null?void 0:y.find(T=>T.track_id===c))!=null,N=new Date(P)<=Date.now()+2*1e3;return l("div",{className:"grid",onClick:T=>I(n),style:{gridTemplateColumns:`1fr 1fr 1fr ${N?"2fr":"1fr 1fr"}`,cursor:"pointer",columnGap:"1em"},children:[e("p",{children:b}),e("p",{children:v.map(T=>`${T.first_name} ${T.last_name}`).join(", ")}),e("p",{children:C==null?void 0:C[0]}),N?e("button",{type:"button",onClick:L,name:c,children:"Restore Track"}):l(U,{children:[_?e("button",{type:"button",onClick:ie,name:c,children:"Remove From Album"}):e("button",{type:"button",onClick:ae,name:c,children:"Add to Album"}),e("button",{type:"button",onClick:O,name:c,children:"Delete Track"})]})]},c)}))})]}),$>=0&&$!=null&&w&&(()=>{const{track_id:r,track_name:n,track_creators:c,deleted_at:b,audio_files:v}=w[$],C=new Date(b)<=Date.now()+2*1e3,P=Array.isArray(v)&&v.length>0;return e(U,{children:l("form",{name:r,onSubmit:le,onClick:_=>{_.stopPropagation()},style:{margin:"2em 0"},children:[e("button",{onClick:()=>I(null),style:{float:"right"},type:"button",children:"Cancel"}),e("h3",{children:"Edit Track"}),l("div",{className:"flex-column gap-s",children:[l("div",{children:[e("h5",{children:"Track Name"}),e("div",{children:e("input",{type:"text",placeholder:"track name...",ref:p,defaultValue:n})})]}),l("div",{children:[e("h5",{children:"Audio File"}),l("div",{children:[e("input",{type:"file",accept:"audio/*",ref:k}),P&&e("button",{type:"button",onClick:oe,name:v[0],children:"Delete File"})]})]}),Array.isArray(c)&&l("div",{children:[e("h5",{children:"Track Creators"}),l("div",{children:[c.map(_=>{const{creator_id:N,first_name:T,last_name:he,is_owner:M}=_,pe=()=>{h.from("track_creators").delete().eq("track_id",r).eq("creator_id",N).then(({data:Ge,error:Y})=>{if(Y)throw Y;f.revalidate()})};return l("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[e("p",{children:`${T} ${he}`}),e("p",{className:"fs-xxs",children:M?"Owner":"Creator"}),e("button",{type:"button",disabled:M,onClick:pe,children:"Remove Track Creator"})]},N)}),l("div",{className:"fs-xxs grid",style:{gridTemplateColumns:"1fr 1fr 1fr"},children:[e("input",{contentEditable:!0,ref:g,placeholder:"username...",style:{marginRight:"1em"}}),l("div",{children:[e("p",{style:{display:"inline",marginRight:".5em"},children:"Is Owner"}),e("input",{type:"checkbox",ref:A})]}),e("button",{type:"button",onClick:se,name:r,children:"Add Track Creator"})]})]})]}),C?e("button",{type:"button",onClick:L,name:r,children:"Restore Track"}):l("div",{className:"flex-center gap-xl",style:{marginTop:"1em"},children:[e("button",{type:"submit",children:"Update Track"}),e("button",{type:"button",onClick:O,name:r,children:"Delete Track"})]})]})]})})})(),l("div",{onClick:r=>{r.stopPropagation()},className:"bg-neutral-700 br-100",style:{padding:"1.25em"},children:[e("h4",{children:"Album Tracks"}),e("div",{style:{maxHeight:"100px",overflowY:"scroll"},children:Array.isArray(y)&&y.length>0?e(U,{children:y==null?void 0:y.map(r=>e(B,{track:r},r.track_id))}):e("p",{children:"None"})})]})]}),l("div",{className:"flex bg-neutral-800",style:{flexWrap:"wrap"},children:[l("div",{className:"bg-neutral-800",style:{padding:"2em",flexBasis:"30%",cursor:"pointer"},onClick:G?V?re:Q:void 0,children:[" ",e("p",{children:V?"Deleted":""}),q&&e("img",{src:R[0].signedUrl,alt:"album cover"}),e("p",{className:"fs-s",children:j}),e("p",{className:"fs-xs",children:x==null?void 0:x.map(r=>`${r.first_name} ${r.last_name}`).join(", ")})]}),Array.isArray(y)&&e("div",{style:{flexBasis:"70%",padding:"1em"},children:y.map(r=>e(B,{track:r},r.track_id))}),!G&&(me?e("button",{type:"button",onClick:de,children:"Un-purchase Album"}):e("button",{type:"button",onClick:ce,children:"Purchase Album"}))]})]})}const Le=async t=>{const i=t.map(m=>{var d;return(d=m.audio_files)==null?void 0:d[0]}).filter(m=>m);if(!i.length)return{signedUrls:[],type:"tracks"};const{data:a,error:s}=await h.storage.from("tracks").createSignedUrls(i,60*5);if(s)throw s;return{signedUrls:a,type:"tracks"}},je=async t=>{const{data:i,error:a}=await h.storage.from("album_covers").createSignedUrls(t.album_covers,300);if(a)throw a;return{signedUrls:i,album_id:t.album_id}},We=async t=>{const i=[];for(const d of t)i.push(je(d)),Array.isArray(d.album_tracks)&&d.album_tracks.length&&i.push(Le(d.album_tracks));const a=await Promise.allSettled(i),s=new Map,m=new Map;for(const d of a){if(d.status!=="fulfilled"){console.warn(`Error loading signed resource urls: ${d.reason}`);continue}if("album_id"in d.value){const{album_id:o,signedUrls:p}=d.value,g=s.get(o);if(Array.isArray(g))for(const k of p)g.push(k);else s.set(o,p??[])}else if(d.value.type==="tracks"){const o=d.value.signedUrls;for(const p of o){const g="/object/sign/tracks/",k=p.signedUrl.indexOf(g)+g.length,A=+p.signedUrl.substring(k,p.signedUrl.indexOf("/",k));m.set(A,p.signedUrl)}}else throw new Error(`Unknown resolved promise ${d}`)}return{albumCovers:s,trackFiles:m}};export{He as A,Be as c,We as f};
